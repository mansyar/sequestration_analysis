<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carbon Sequestration Calculator | Indonesia 2050</title>
    <meta
      name="description"
      content="Calculate required forest and coastal area to achieve Indonesia's 2050 carbon emission targets"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}" />
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1>üåø Carbon Sequestration Calculator</h1>
        <p class="subtitle">
          Indonesia's Path to Net Zero 2050 | IPCC 2006 Tier 1 Methodology
        </p>
      </header>

      <!-- Navigation -->
      <nav class="nav">
        <a href="/" class="active">üìä Calculator</a>
        <a href="/references">üìö References</a>
      </nav>

      <form method="POST" action="/calculate" id="calculatorForm">
        <div class="grid grid-2">
          <!-- Left Column: Inputs -->
          <div>
            <!-- Scenario Selection -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üéØ</span>
                <h2>Quick Scenarios</h2>
              </div>
              <div class="btn-group">
                {% for key, scenario in scenario_presets.items() %}
                <button
                  type="button"
                  class="scenario-btn"
                  data-scenario="{{ key }}"
                  data-forest="{{ scenario.forest_percent * 100 }}"
                  data-below-ground="{{ 'true' if scenario.include_below_ground else 'false' }}"
                  title="{{ scenario.description }}"
                >
                  {{ scenario.name }}
                </button>
                {% endfor %}
              </div>
              <input
                type="hidden"
                name="scenario"
                id="scenarioInput"
                value="custom"
              />
            </div>

            <!-- Emission Targets -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üè≠</span>
                <h2>Emission Targets</h2>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="emissions_2030">Baseline 2030 (MtCO‚ÇÇe)</label>
                  <input
                    type="number"
                    id="emissions_2030"
                    name="emissions_2030"
                    value="{{ defaults.emissions_2030 }}"
                    step="1"
                    min="0"
                    max="5000"
                  />
                </div>
                <div class="form-group">
                  <label for="target_2050">Target 2050 (MtCO‚ÇÇe)</label>
                  <input
                    type="number"
                    id="target_2050"
                    name="target_2050"
                    value="{{ defaults.target_2050 }}"
                    step="1"
                    min="0"
                    max="5000"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="sequestration_percent">
                  Sequestration Policy:
                  <span class="range-value" id="seqPercentValue"
                    >{{ defaults.sequestration_percent }}%</span
                  >
                </label>
                <input
                  type="range"
                  id="sequestration_percent"
                  name="sequestration_percent"
                  value="{{ defaults.sequestration_percent }}"
                  min="0"
                  max="100"
                  step="5"
                />
              </div>
            </div>

            <!-- Current Indonesia Forest Areas -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üå≥</span>
                <h2>Current Indonesia Forest Areas</h2>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="forest_area_available">Land Forest (ha)</label>
                  <input
                    type="number"
                    id="forest_area_available"
                    name="forest_area_available"
                    value="{{ defaults.forest_area_available }}"
                    step="1000"
                  />
                </div>
                <div class="form-group">
                  <label for="coastal_area_available"
                    >Coastal Forest (ha)</label
                  >
                  <input
                    type="number"
                    id="coastal_area_available"
                    name="coastal_area_available"
                    value="{{ defaults.coastal_area_available }}"
                    step="1000"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="forest_percent">
                  Sequestration Allocation (Forest/Coastal):
                  <span class="range-value" id="forestPercentValue"
                    >{{ defaults.forest_percent|int }}% / {{ (100 -
                    defaults.forest_percent)|int }}%</span
                  >
                </label>
                <input
                  type="range"
                  id="forest_percent"
                  name="forest_percent"
                  value="{{ defaults.forest_percent }}"
                  min="0"
                  max="100"
                  step="5"
                />
              </div>
            </div>

            <!-- Sequestration Rates -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üìà</span>
                <h2>IPCC Tier 1 Rates</h2>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="forest_rate">Forest Rate (tCO‚ÇÇ/ha/yr)</label>
                  <input
                    type="number"
                    id="forest_rate"
                    name="forest_rate"
                    value="{{ defaults.forest_rate }}"
                    step="0.5"
                    min="1"
                    max="50"
                  />
                </div>
                <div class="form-group">
                  <label for="coastal_rate">Coastal Rate (tCO‚ÇÇ/ha/yr)</label>
                  <input
                    type="number"
                    id="coastal_rate"
                    name="coastal_rate"
                    value="{{ defaults.coastal_rate }}"
                    step="0.5"
                    min="1"
                    max="50"
                  />
                </div>
              </div>
              <div class="form-group">
                <div class="toggle-wrapper">
                  <label class="toggle">
                    <input
                      type="checkbox"
                      id="include_below_ground"
                      name="include_below_ground"
                      {%
                      if
                      defaults.include_below_ground
                      %}checked{%
                      endif
                      %}
                    />
                    <span class="toggle-slider"></span>
                  </label>
                  <label for="include_below_ground"
                    >Include below-ground biomass (+37%)</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label for="root_to_shoot_ratio">Root-to-Shoot Ratio</label>
                <input
                  type="number"
                  id="root_to_shoot_ratio"
                  name="root_to_shoot_ratio"
                  value="{{ defaults.root_to_shoot_ratio }}"
                  step="0.01"
                  min="0.1"
                  max="1"
                />
              </div>

              <!-- Risk Scenarios (Checkboxes for chart comparison) -->
              <div
                class="form-group"
                style="
                  background: rgba(239, 68, 68, 0.1);
                  padding: 1rem;
                  border-radius: var(--radius-md);
                  border: 1px solid rgba(239, 68, 68, 0.3);
                "
              >
                <label
                  style="
                    color: var(--accent-danger);
                    margin-bottom: 0.75rem;
                    display: block;
                  "
                >
                  ‚ö†Ô∏è Risk Scenarios (shown on charts):
                </label>
                <!-- Hidden inputs to ensure form submission -->
                <input
                  type="hidden"
                  name="risk_factor"
                  value="{{ defaults.risk_factor }}"
                />

                <div style="display: flex; gap: 1rem; flex-wrap: wrap">
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      name="risk_optimistic"
                      value="Optimistic"
                      checked
                      style="width: 18px; height: 18px; accent-color: #22c55e"
                    />
                    <span style="color: #22c55e; font-weight: 500"
                      >üü¢ Optimistic (0%)</span
                    >
                  </label>

                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      name="risk_moderate"
                      value="Moderate"
                      checked
                      style="width: 18px; height: 18px; accent-color: #f59e0b"
                    />
                    <span style="color: #f59e0b; font-weight: 500"
                      >üü° Moderate (20%)</span
                    >
                  </label>

                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      name="risk_pessimistic"
                      value="Pessimistic"
                      checked
                      style="width: 18px; height: 18px; accent-color: #ef4444"
                    />
                    <span style="color: #ef4444; font-weight: 500"
                      >üî¥ Pessimistic (40%)</span
                    >
                  </label>
                </div>

                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    margin-top: 0.75rem;
                  "
                >
                  Select scenarios to compare on charts. Risk accounts for
                  fires, pests, drought, etc.
                </p>
              </div>

              <!-- Forest Degradation Rate -->
              <div
                class="form-group"
                style="
                  background: rgba(245, 158, 11, 0.1);
                  padding: 1rem;
                  border-radius: var(--radius-md);
                  border: 1px solid rgba(245, 158, 11, 0.3);
                "
              >
                <label for="degradation_rate" style="color: #f59e0b">
                  üìâ Forest Degradation Rate (% per year):
                  <span class="range-value" id="degradationRateValue"
                    >{{ defaults.degradation_rate|round(1) }}%</span
                  >
                </label>
                <input
                  type="range"
                  id="degradation_rate"
                  name="degradation_rate"
                  value="{{ defaults.degradation_rate }}"
                  min="0"
                  max="10"
                  step="0.5"
                />
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    margin-top: 0.5rem;
                  "
                >
                  Annual loss of existing forest sequestration capacity
                  (deforestation, degradation)
                </p>
              </div>
            </div>

            <!-- Time Parameters -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üìÖ</span>
                <h2>Time Parameters</h2>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="start_year">Start Year</label>
                  <input
                    type="number"
                    id="start_year"
                    name="start_year"
                    value="{{ defaults.start_year }}"
                    min="2020"
                    max="2100"
                  />
                </div>
                <div class="form-group">
                  <label for="target_year">Target Year</label>
                  <input
                    type="number"
                    id="target_year"
                    name="target_year"
                    value="{{ defaults.target_year }}"
                    min="2025"
                    max="2100"
                  />
                </div>
              </div>
            </div>

            <button
              type="submit"
              class="btn btn-primary"
              style="width: 100%; padding: 1rem"
            >
              üßÆ Calculate Required Area
            </button>
          </div>

          <!-- Right Column: Results -->
          <div>
            <!-- Summary Results -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üìä</span>
                <h2>Results Summary</h2>
                {% if result.overall_feasible %}
                <span class="badge badge-success">‚úì Feasible</span>
                {% else %}
                <span class="badge badge-danger">‚úó Not Feasible</span>
                {% endif %}
              </div>
              <div class="result-grid">
                <div class="result-item">
                  <div class="value">
                    {{ "{:,.0f}".format(result.total_reduction_needed) }}
                  </div>
                  <div class="label">Total Reduction (MtCO‚ÇÇe)</div>
                </div>
                <div class="result-item">
                  <div class="value">
                    {{ "{:,.0f}".format(result.sequestration_target) }}
                  </div>
                  <div class="label">From Sequestration (MtCO‚ÇÇe)</div>
                </div>
                <div
                  class="result-item {% if not result.overall_feasible %}warning{% endif %}"
                >
                  <div class="value">
                    {{ "{:,.0f}".format(result.total_area_needed) }}
                  </div>
                  <div class="label">New Reforestation Needed (ha)</div>
                </div>
                <div class="result-item">
                  <div class="value">{{ result.years }}</div>
                  <div class="label">Years</div>
                </div>
              </div>
            </div>

            <!-- Forest Feasibility -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üå≤</span>
                <h2>Land Forest Reforestation</h2>
                {% if result.forest_feasibility.is_feasible %}
                <span class="badge badge-success">‚úì Feasible</span>
                {% else %}
                <span class="badge badge-danger">‚úó Exceeds Capacity</span>
                {% endif %}
              </div>
              <div class="result-grid">
                <div class="result-item">
                  <div class="value">
                    {{ "{:,.0f}".format(result.forest_area_needed) }}
                  </div>
                  <div class="label">New Planting Needed (ha)</div>
                </div>
                <div class="result-item">
                  <div class="value">
                    {{
                    "{:,.0f}".format(result.forest_feasibility.area_available)
                    }}
                  </div>
                  <div class="label">Current Forest (ha)</div>
                </div>
                <div
                  class="result-item {% if result.forest_feasibility.utilization_percent > 100 %}danger{% elif result.forest_feasibility.utilization_percent > 80 %}warning{% endif %}"
                >
                  <div class="value">
                    {{
                    "{:.1f}".format(result.forest_feasibility.utilization_percent)
                    }}%
                  </div>
                  <div class="label">Utilization</div>
                </div>
                <div class="result-item">
                  <div class="value">
                    {{ "{:.1f}".format(result.effective_forest_rate) }}
                  </div>
                  <div class="label">Rate (tCO‚ÇÇ/ha/yr)</div>
                </div>
              </div>
            </div>

            <!-- Coastal Feasibility -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üåä</span>
                <h2>Coastal/Mangrove Restoration</h2>
                {% if result.coastal_feasibility.is_feasible %}
                <span class="badge badge-success">‚úì Feasible</span>
                {% else %}
                <span class="badge badge-danger">‚úó Exceeds Capacity</span>
                {% endif %}
              </div>
              <div class="result-grid">
                <div class="result-item">
                  <div class="value">
                    {{ "{:,.0f}".format(result.coastal_area_needed) }}
                  </div>
                  <div class="label">New Restoration Needed (ha)</div>
                </div>
                <div class="result-item">
                  <div class="value">
                    {{
                    "{:,.0f}".format(result.coastal_feasibility.area_available)
                    }}
                  </div>
                  <div class="label">Current Coastal (ha)</div>
                </div>
                <div
                  class="result-item {% if result.coastal_feasibility.utilization_percent > 100 %}danger{% elif result.coastal_feasibility.utilization_percent > 80 %}warning{% endif %}"
                >
                  <div class="value">
                    {{
                    "{:.1f}".format(result.coastal_feasibility.utilization_percent)
                    }}%
                  </div>
                  <div class="label">Utilization</div>
                </div>
                <div class="result-item">
                  <div class="value">
                    {{ "{:.1f}".format(result.effective_coastal_rate) }}
                  </div>
                  <div class="label">Rate (tCO‚ÇÇ/ha/yr)</div>
                </div>
              </div>
            </div>

            <!-- Scenario Comparison -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üìã</span>
                <h2>Scenario Comparison</h2>
              </div>
              <p class="text-success mb-2">{{ scenarios.recommendation }}</p>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Scenario</th>
                      <th>Total Area (ha)</th>
                      <th>Forest %</th>
                      <th>Coastal %</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for scenario in scenarios.scenarios %}
                    <tr>
                      <td>{{ scenario.scenario_name }}</td>
                      <td>
                        {{ "{:,.0f}".format(scenario.result.total_area_needed)
                        }}
                      </td>
                      <td>
                        {{
                        "{:.1f}".format(scenario.result.forest_feasibility.utilization_percent)
                        }}%
                      </td>
                      <td>
                        {{
                        "{:.1f}".format(scenario.result.coastal_feasibility.utilization_percent)
                        }}%
                      </td>
                      <td>
                        {% if scenario.result.overall_feasible %}
                        <span class="badge badge-success">‚úì</span>
                        {% else %}
                        <span class="badge badge-danger">‚úó</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </form>

      <!-- Charts Section -->
      <div class="grid grid-2 mt-3">
        <!-- Area Comparison Chart -->
        <div class="card">
          <div class="card-header">
            <span class="icon">üìä</span>
            <h2>Current vs Required Area by Risk</h2>
          </div>
          <div style="position: relative; height: 300px">
            <canvas id="areaComparisonChart"></canvas>
          </div>
          <p class="text-muted mt-2 text-center" style="font-size: 0.85rem">
            Gray = Current area | üü¢ Optimistic | üü° Moderate | üî¥ Pessimistic
          </p>
        </div>

        <!-- Annual Trajectory Chart -->
        <div class="card">
          <div class="card-header">
            <span class="icon">üìà</span>
            <h2>
              Reforestation Trajectory ({{ defaults.start_year }}-{{
              defaults.target_year }})
            </h2>
          </div>
          <div style="position: relative; height: 300px">
            <canvas id="trajectoryChart"></canvas>
          </div>
          <p class="text-muted mt-2 text-center" style="font-size: 0.85rem">
            Cumulative area growth by risk scenario: üü¢ Optimistic | üü° Moderate
            | üî¥ Pessimistic
          </p>
        </div>
      </div>

      <!-- Risk Scenario Comparison Chart (Stacked) -->
      <div class="card mt-3">
        <div class="card-header">
          <span class="icon">‚ö†Ô∏è</span>
          <h2>Risk Scenario Comparison - Stacked Area Needed</h2>
        </div>
        <div style="position: relative; height: 280px">
          <canvas id="scenarioChart"></canvas>
        </div>
        <p class="text-muted mt-2 text-center" style="font-size: 0.85rem">
          üü¢ Optimistic (0% risk) | üü° Moderate (20% risk) | üî¥ Pessimistic (40%
          risk) ‚Äî Stacked: Forest + Coastal
        </p>
      </div>

      <!-- Emissions Trajectory Chart -->
      <div class="card mt-3">
        <div class="card-header">
          <span class="icon">üåç</span>
          <h2>Emissions Reduction Trajectory</h2>
        </div>
        <div style="position: relative; height: 300px">
          <canvas id="emissionsChart"></canvas>
        </div>
        <p class="text-muted mt-2 text-center" style="font-size: 0.85rem">
          Projected emissions decline from {{ defaults.start_year }} to {{
          defaults.target_year }} with sequestration contribution
        </p>
      </div>

      <!-- Methodology Link -->
      <div class="card mt-3" style="text-align: center; padding: 1.5rem">
        <h3 style="margin-bottom: 0.5rem">
          üìö Want to understand the calculations?
        </h3>
        <p style="margin-bottom: 1rem; color: var(--text-muted)">
          Learn about the IPCC methodology, formulas, and assumptions behind
          this calculator.
        </p>
        <a
          href="/methodology"
          class="btn-submit"
          style="
            display: inline-block;
            text-decoration: none;
            max-width: 300px;
            margin: 0 auto;
          "
        >
          View Methodology & Theory
        </a>
      </div>

      <!-- Footer -->
      <footer class="footer">
        <p>Based on IPCC 2006 Guidelines Vol.4 (AFOLU) ‚Ä¢ Tier 1 Methodology</p>
        <p class="mt-2">Data sources: Indonesia NDC 2022, FOLU Net Sink 2030</p>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', path='/app.js') }}"></script>
    <script>
      // Chart data from backend
      const chartData = {{ chart_data | tojson }};
      const multiRiskData = {{ multi_risk_data | tojson }};
      // Color palette
      const colors = {
        forest: '#10b981',
        forestLight: 'rgba(16, 185, 129, 0.3)',
        coastal: '#3b82f6',
        coastalLight: 'rgba(59, 130, 246, 0.3)',
        warning: '#f59e0b',
        danger: '#ef4444',
        gradient1: '#10b981',
        gradient2: '#3b82f6',
        grid: 'rgba(255, 255, 255, 0.1)',
        text: '#9ca3af'
      };

      // Common chart options
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: colors.text }
          }
        },
        scales: {
          x: {
            ticks: { color: colors.text },
            grid: { color: colors.grid }
          },
          y: {
            ticks: { color: colors.text },
            grid: { color: colors.grid }
          }
        }
      };

      // 1. Area Comparison Chart (Current vs Risk Scenarios)
      new Chart(document.getElementById('areaComparisonChart'), {
        type: 'bar',
        data: {
          labels: ['Forest', 'Coastal'],
          datasets: [
            {
              label: 'Current Area',
              data: [multiRiskData.current_forest, multiRiskData.current_coastal],
              backgroundColor: ['rgba(107, 114, 128, 0.8)', 'rgba(107, 114, 128, 0.8)'],
              borderColor: ['#6b7280', '#6b7280'],
              borderWidth: 2
            },
            ...multiRiskData.scenarios.map(s => ({
              label: s.name + ' (' + s.risk_factor + '% risk)',
              data: [s.forest_area_needed, s.coastal_area_needed],
              backgroundColor: [s.color + '99', s.color + '66'],
              borderColor: [s.color, s.color],
              borderWidth: 2
            }))
          ]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  if (value >= 1000000) {
                    return context.dataset.label + ': ' + (value / 1000000).toFixed(2) + 'M ha';
                  }
                  return context.dataset.label + ': ' + value.toLocaleString() + ' ha';
                }
              }
            }
          },
          scales: {
            ...commonOptions.scales,
            y: {
              ...commonOptions.scales.y,
              title: {
                display: true,
                text: 'Area (hectares)',
                color: colors.text
              }
            }
          }
        }
      });

      // 2. Annual Trajectory Chart - Multi Risk Scenario Lines
      new Chart(document.getElementById('trajectoryChart'), {
        type: 'line',
        data: {
          labels: multiRiskData.scenarios[0]?.years || chartData.trajectory.years,
          datasets: multiRiskData.scenarios.flatMap(s => [
            {
              label: s.name + ' - Total Area (ha)',
              data: s.area_trajectory,
              borderColor: s.color,
              backgroundColor: s.color + '33',
              fill: false,
              tension: 0.3,
              borderWidth: 3,
              pointRadius: 2
            }
          ])
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            title: {
              display: true,
              text: 'Cumulative Reforestation/Restoration by Risk Scenario',
              color: colors.text,
              font: { size: 14 }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  if (value >= 1000000) {
                    return context.dataset.label + ': ' + (value / 1000000).toFixed(2) + 'M ha';
                  }
                  return context.dataset.label + ': ' + Math.round(value).toLocaleString() + ' ha';
                }
              }
            },
            legend: {
              labels: { color: colors.text }
            }
          },
          scales: {
            ...commonOptions.scales,
            y: {
              ...commonOptions.scales.y,
              title: {
                display: true,
                text: 'Cumulative Area Needed (ha)',
                color: colors.text
              }
            }
          }
        }
      });

      // 3. Risk Scenario Stacked Bar Chart
      new Chart(document.getElementById('scenarioChart'), {
        type: 'bar',
        data: {
          labels: multiRiskData.scenarios.map(s => s.name + ' (' + s.risk_factor + '%)'),
          datasets: [
            {
              label: 'Forest Reforestation (Million ha)',
              data: multiRiskData.scenarios.map(s => s.forest_area_needed / 1000000),
              backgroundColor: multiRiskData.scenarios.map(s => s.color + 'DD'),
              borderColor: multiRiskData.scenarios.map(s => s.color),
              borderWidth: 2,
              stack: 'stack1'
            },
            {
              label: 'Coastal Restoration (Million ha)',
              data: multiRiskData.scenarios.map(s => s.coastal_area_needed / 1000000),
              backgroundColor: multiRiskData.scenarios.map(s => s.color + '66'),
              borderColor: multiRiskData.scenarios.map(s => s.color),
              borderWidth: 2,
              stack: 'stack1'
            }
          ]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.raw.toFixed(2) + ' M ha';
                },
                afterBody: function(context) {
                  const idx = context[0].dataIndex;
                  const scenario = multiRiskData.scenarios[idx];
                  const total = (scenario.forest_area_needed + scenario.coastal_area_needed) / 1000000;
                  return ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'Total: ' + total.toFixed(2) + ' M ha'];
                }
              }
            }
          },
          scales: {
            ...commonOptions.scales,
            x: {
              stacked: true,
              ...commonOptions.scales.x
            },
            y: {
              stacked: true,
              ...commonOptions.scales.y,
              title: {
                display: true,
                text: 'Area Needed (Million ha)',
                color: colors.text
              }
            }
          }
        }
      });

      // 4. Emissions Trajectory Chart - Multi Risk
      new Chart(document.getElementById('emissionsChart'), {
        type: 'line',
        data: {
          labels: multiRiskData.scenarios[0]?.years || chartData.trajectory.years,
          datasets: multiRiskData.scenarios.map(s => ({
            label: s.name + ' (' + s.risk_factor + '% risk)',
            data: s.emissions_trajectory,
            borderColor: s.color,
            backgroundColor: s.color + '22',
            fill: s.name === 'Moderate' ? true : false,
            tension: 0.3,
            borderWidth: s.name === 'Moderate' ? 4 : 2,
            pointRadius: s.name === 'Moderate' ? 4 : 2
          }))
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + Math.round(context.raw).toLocaleString() + ' MtCO‚ÇÇe';
                }
              }
            }
          },
          scales: {
            ...commonOptions.scales,
            y: {
              ...commonOptions.scales.y,
              title: {
                display: true,
                text: 'Emissions (MtCO‚ÇÇe)',
                color: colors.text
              },
              min: 0
            }
          }
        }
      });
    </script>
  </body>
</html>
