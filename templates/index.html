<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carbon Sequestration Calculator | Indonesia 2050</title>
    <meta
      name="description"
      content="Calculate required forest and coastal area to achieve Indonesia's 2050 carbon emission targets"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/png" href="{{ url_for('static', path='/favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <body>
    <div>
      <!-- Header -->
      <header class="header">
        <h1>üåø Carbon Sequestration Calculator</h1>
        <p class="subtitle">
          Indonesia's Path to Net Zero 2050 | IPCC 2006 Tier 1 Methodology
        </p>
      </header>

      <!-- Navigation -->
      <nav class="nav">
        <a href="/" class="active">üìä Calculator</a>
        <a href="/references">üìö References</a>
      </nav>

      <form method="POST" action="/calculate" id="calculatorForm">
        <div class="dashboard-layout">
          <!-- Left Column: Inputs (Sidebar) -->
          <aside class="dashboard-sidebar">
            <!-- Time Parameters -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üìÖ</span>
                <h2>Time Parameters</h2>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="initial_year">Initial Year</label>
                  <input
                    type="number"
                    id="initial_year"
                    name="initial_year"
                    value="{{ defaults.initial_year }}"
                    min="2000"
                    max="2100"
                  />
                </div>
                <div class="form-group">
                  <label for="peak_year">Peak Year</label>
                  <input
                    type="number"
                    id="peak_year"
                    name="peak_year"
                    value="{{ defaults.peak_year }}"
                    min="2000"
                    max="2100"
                  />
                </div>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="target_year">Target Year</label>
                  <input
                    type="number"
                    id="target_year"
                    name="target_year"
                    value="{{ defaults.target_year }}"
                    min="2025"
                    max="2100"
                  />
                </div>
                <div class="form-group">
                  <label for="new_planting_start_year">Planting Start Year</label>
                  <input
                    type="number"
                    id="new_planting_start_year"
                    name="new_planting_start_year"
                    value="{{ defaults.new_planting_start_year }}"
                    min="2000"
                    max="2100"
                  />
                </div>
              </div>
            </div>

            <!-- Emission Data Points (3-Point Model) -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üè≠</span>
                <h2>Emission Trajectory (MtCO‚ÇÇe)</h2>
              </div>
              <div class="grid grid-3">
                <div class="form-group">
                  <label for="emissions_initial">Initial Value</label>
                  <input
                    type="number"
                    id="emissions_initial"
                    name="emissions_initial"
                    value="{{ defaults.emissions_initial }}"
                    step="any"
                    min="0"
                  />
                </div>
                <div class="form-group">
                  <label for="emissions_peak">Peak Value</label>
                  <input
                    type="number"
                    id="emissions_peak"
                    name="emissions_peak"
                    value="{{ defaults.emissions_peak }}"
                    step="any"
                    min="0"
                  />
                </div>
                <div class="form-group">
                  <label for="target_2050">Target Value</label>
                  <input
                    type="number"
                    id="target_2050"
                    name="target_2050"
                    value="{{ defaults.target_2050 }}"
                    step="any"
                    min="0"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="sequestration_percent">
                  Sequestration Policy (FOLU %):
                  <span class="range-value" id="seqPercentValue"
                    >{{ defaults.sequestration_percent }}%</span
                  >
                </label>
                <input
                  type="range"
                  id="sequestration_percent"
                  name="sequestration_percent"
                  value="{{ defaults.sequestration_percent }}"
                  min="0"
                  max="100"
                  step="5"
                />
              </div>
            </div>

            <!-- Forest Area & Allocation -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üå≥</span>
                <h2>Forest Area & Allocation</h2>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="forest_area_available">Existing Land Forest Area (ha)</label>
                  <input
                    type="number"
                    id="forest_area_available"
                    name="forest_area_available"
                    value="{{ defaults.forest_area_available }}"
                    step="any"
                  />
                </div>
                <div class="form-group">
                  <label for="coastal_area_available">Existing Coastal Forest Area (ha)</label>
                  <input
                    type="number"
                    id="coastal_area_available"
                    name="coastal_area_available"
                    value="{{ defaults.coastal_area_available }}"
                    step="any"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="new_planting_forest_percent">
                  New Planting Allocation (Forest %):
                  <span class="range-value" id="forestPercentValue"
                    >{{ defaults.new_planting_forest_percent|int }}% / {{ (100 -
                    defaults.new_planting_forest_percent)|int }}%</span
                  >
                </label>
                <input
                  type="range"
                  id="new_planting_forest_percent"
                  name="new_planting_forest_percent"
                  value="{{ defaults.new_planting_forest_percent }}"
                  min="0"
                  max="100"
                  step="5"
                />
              </div>
              <div class="form-group">
                <label for="existing_forest_status">Existing Forest Carbon Status</label>
                <select id="existing_forest_status" name="existing_forest_status" style="width: 100%; padding: 0.75rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                  <option value="mature" {% if defaults.existing_forest_status == 'mature' %}selected{% endif %}>üå≥ Mature (0% - Carbon Equilibrium)</option>
                  <option value="mixed" {% if defaults.existing_forest_status == 'mixed' %}selected{% endif %}>üå≤ Mixed (50% - Partial Absorption)</option>
                  <option value="active" {% if defaults.existing_forest_status == 'active' %}selected{% endif %}>üå± Active (100% - Full Absorption)</option>
                </select>
              </div>
            </div>



            <!-- Sequestration Rates -->
            <div class="card">
              <div class="card-header">
                <span class="icon">üìà</span>
                <h2>IPCC Tier 1 Rates</h2>
              </div>
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="forest_rate">Forest Rate (tCO‚ÇÇ/ha/yr)</label>
                  <input
                    type="number"
                    id="forest_rate"
                    name="forest_rate"
                    value="{{ defaults.forest_rate }}"
                    step="any"
                    min="0"
                    max="100"
                  />
                </div>
                <div class="form-group">
                  <label for="coastal_rate">Coastal Rate (tCO‚ÇÇ/ha/yr)</label>
                  <input
                    type="number"
                    id="coastal_rate"
                    name="coastal_rate"
                    value="{{ defaults.coastal_rate }}"
                    step="any"
                    min="0"
                    max="100"
                  />
                </div>
              </div>
              <div class="form-group">
                <div class="toggle-wrapper">
                  <label class="toggle">
                    <input
                      type="checkbox"
                      id="include_below_ground"
                      name="include_below_ground"
                      {%
                      if
                      defaults.include_below_ground
                      %}checked{%
                      endif
                      %}
                    />
                    <span class="toggle-slider"></span>
                  </label>
                  <label for="include_below_ground"
                    >Include below-ground biomass (+37%)</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label for="root_to_shoot_ratio">Root-to-Shoot Ratio</label>
                <input
                  type="number"
                  id="root_to_shoot_ratio"
                  name="root_to_shoot_ratio"
                  value="{{ defaults.root_to_shoot_ratio }}"
                  step="any"
                  min="0.1"
                  max="1"
                />
              </div>

              <!-- Risk Scenarios (Checkboxes for chart comparison) -->
              <div class="form-group warning-box">
                <label
                  style="
                    color: var(--accent-danger);
                    margin-bottom: 0.75rem;
                    display: block;
                  "
                >
                  ‚ö†Ô∏è Risk Scenarios (shown on charts):
                </label>
                <!-- Hidden inputs to ensure form submission -->
                <input
                  type="hidden"
                  name="risk_factor"
                  value="{{ defaults.risk_factor }}"
                />

                <div style="display: flex; gap: 1rem; flex-wrap: wrap">
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      name="risk_optimistic"
                      value="Optimistic"
                      checked
                      style="width: 18px; height: 18px; accent-color: #22c55e"
                    />
                    <span style="color: #22c55e; font-weight: 500"
                      >üü¢ Optimistic (0%)</span
                    >
                  </label>

                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      name="risk_moderate"
                      value="Moderate"
                      checked
                      style="width: 18px; height: 18px; accent-color: #f59e0b"
                    />
                    <span style="color: #f59e0b; font-weight: 500"
                      >üü° Moderate (20%)</span
                    >
                  </label>

                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      name="risk_pessimistic"
                      value="Pessimistic"
                      checked
                      style="width: 18px; height: 18px; accent-color: #ef4444"
                    />
                    <span style="color: #ef4444; font-weight: 500"
                      >üî¥ Pessimistic (40%)</span
                    >
                  </label>
                </div>

                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    margin-top: 0.75rem;
                  "
                >
                  Select scenarios to compare on charts. Risk accounts for
                  fires, pests, drought, etc.
                </p>
              </div>

              <!-- Forest Degradation Rate -->
              <div class="form-group warning-box">
                <label for="degradation_rate" style="color: var(--accent-warning)">
                  üìâ Forest Degradation Rate (% per year):
                  <span class="range-value" id="degradationRateValue"
                    >{{ defaults.degradation_rate|round(1) }}%</span
                  >
                </label>
                <input
                  type="range"
                  id="degradation_rate"
                  name="degradation_rate"
                  value="{{ defaults.degradation_rate }}"
                  min="0"
                  max="10"
                  step="0.5"
                />
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    margin-top: 0.5rem;
                  "
                >
                  Annual loss of existing forest sequestration capacity
                  (deforestation, degradation)
                </p>
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
              <button type="submit" class="calculate-btn" style="flex: 2;">
                üöÄ Calculate Sequestration
              </button>
              <button type="button" id="resetBtn" class="scenario-btn" style="flex: 1; margin: 0; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                üîÑ Reset
              </button>
            </div>

          </aside>

          <!-- Right Column: Results (Main) -->
          <main class="dashboard-main">
            <!-- Summary Results -->
            <div class="card mb-6">
              <div class="card-header">
                <h2>Analysis Summary</h2>
              </div>
              <div class="result-grid">
                <div class="result-item">
                  <div class="value">
                    {{ "{:,.0f}".format(result.total_reduction_needed) }}
                  </div>
                  <div class="label">Net Reduction (MtCO‚ÇÇe)</div>
                </div>
                <div class="result-item">
                  <div class="value">
                    {{ "{:,.0f}".format(result.sequestration_target) }}
                  </div>
                  <div class="label">FOLU Target (MtCO‚ÇÇe)</div>
                </div>
                <div class="result-item">
                  <div class="value">
                    {{ "{:,.1f}".format(result.total_area_needed / 1000000) }}
                  </div>
                  <div class="label">Total New Area (Mha)</div>
                </div>
                <div class="result-item">
                  <div class="value">{{ result.years }}</div>
                  <div class="label">Analysis Period</div>
                </div>
              </div>
              <button type="button" id="generatePdfBtn" class="btn btn-secondary" style="width: 100%; margin-top: 1rem">
                üìÑ &nbsp; Export Technical Analysis (PDF)
              </button>
            </div>



            <div class="charts-grid">

            <!-- Figure 1: Existing Forest Carbon Reduction -->
            <div class="card mb-6">
              <div class="card-header">
                <h2>Figure 1: Existing Forest Carbon Reduction</h2>
              </div>
              <div class="chart-container" style="height: 250px">
                <canvas id="existingForestRateChart"></canvas>
              </div>
              <p class="chart-caption">Shows the total annual carbon reduction (MtCO‚ÇÇe/yr) from existing forests, accounting for degradation.</p>
            </div>

            <!-- Figure 2: Gross Emissions -->
            <div class="card mb-6">
              <div class="card-header">
                <h2>Figure 2: Gross Emission Trajectory</h2>
              </div>
              <div class="chart-container" style="height: 250px">
                <canvas id="grossEmissionsChart"></canvas>
              </div>
              <p class="chart-caption">Linear interpolation between Initial, Peak, and 2050 Target points.</p>
            </div>

            <!-- Figure 3: Carbon Balance -->
            <div class="card mb-6">
              <div class="card-header">
                <h2>Figure 3: Carbon Balance</h2>
              </div>
              <div class="chart-container" style="height: 300px">
                <canvas id="balanceChart"></canvas>
              </div>
              <p class="chart-caption">Gap between gross emissions and existing sequestration (to be filled by new planting).</p>
            </div>

            <!-- Figure 4: Annual New Planting Area -->
            <div class="card mb-6">
              <div class="card-header">
                <h2>Figure 4: Annual New Planting Area</h2>
              </div>
              <div class="chart-container" style="height: 250px">
                <canvas id="annualPlantingChart"></canvas>
              </div>
              <p class="chart-caption">Hectares required to be planted each year to meet the policy target.</p>
            </div>

            <div class="card mb-6">
              <div class="card-header">
                <h2>Figure 5: Cumulative Planted Area</h2>
              </div>
              <div class="chart-container" style="height: 300px">
                <canvas id="cumulativeAreaChart"></canvas>
              </div>
              <p class="chart-caption">Total accumulated restoration area including required projection beyond target year.</p>
            </div>






            <!-- Figure 6: National Net Carbon Balance -->
            <div class="card mb-6">
              <div class="card-header">
                <h2>Figure 6: National Net Carbon Balance</h2>
              </div>
              <div class="chart-container" style="height: 350px">
                <canvas id="netZeroBalanceChart"></canvas>
              </div>
              <p class="chart-caption">Comprehensive view of net-zero achievement, combining gross emissions with both existing and new carbon sinks.</p>
            </div>
            </div>
          </main>
        </div>
      </form>

      <!-- Feasibility Details (Optional, collapsed or bottom) -->
      <div class="grid grid-2 mt-8">
            <!-- Land Forest Feasibility -->
            <div class="card">
              <div class="card-header">
                <h2>Land Forest Requirement</h2>
              </div>
              <div class="result-grid">
                <div class="result-item">
                  <div class="value">{{ "{:,.1f}".format(result.forest_area_needed / 1000000) }}</div>
                  <div class="label">Required (Mha)</div>
                </div>
              </div>
            </div>

            <!-- Coastal Feasibility -->
            <div class="card">
              <div class="card-header">
                <h2>Coastal/Mangrove Requirement</h2>
              </div>
              <div class="result-grid">
                <div class="result-item">
                  <div class="value">{{ "{:,.1f}".format(result.coastal_area_needed / 1000000) }}</div>
                  <div class="label">Required (Mha)</div>
                </div>
              </div>
            </div>
      </div>
    </div>

      <!-- Methodology Link -->
      <div class="card mt-3" style="text-align: center; padding: 1.5rem">
        <h3 style="margin-bottom: 0.5rem">
          üìö Want to understand the calculations?
        </h3>
        <p style="margin-bottom: 1rem; color: var(--text-muted)">
          Learn about the IPCC methodology, formulas, and assumptions behind
          this calculator.
        </p>
        <a
          href="/methodology"
          class="btn-submit"
          style="
            display: inline-block;
            text-decoration: none;
            max-width: 300px;
            margin: 0 auto;
          "
        >
          View Methodology & Theory
        </a>
      </div>

      <!-- Footer -->
      <footer class="footer">
        <p>Based on IPCC 2006 Guidelines Vol.4 (AFOLU) ‚Ä¢ Tier 1 Methodology</p>
        <p class="mt-2">Data sources: Indonesia NDC 2022, FOLU Net Sink 2030</p>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', path='/app.js') }}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        console.log("Initializing Dashboard Charts...");
        
        // 1. Data Initialization
        const rawChartData = {{ chart_data|tojson }};
        const dashboardDefaults = {{ defaults|tojson }};
        
        console.log("Raw Chart Data:", rawChartData);
        
        if (!rawChartData) {
            console.error("Critical: chartData is missing from template context");
            return;
        }

        const chartData = rawChartData;
        window.dashboardCharts = {};
        
        // 2. Color Palette
        const colors = {
          forest: "#15803d",
          forestLight: "rgba(21, 128, 61, 0.1)",
          coastal: "#0369a1",
          coastalLight: "rgba(3, 105, 161, 0.1)",
          emissions: "#475569",
          balance: "#be123c",
          target: "#b45309",
          grid: "rgba(0, 0, 0, 0.03)",
          text: "#64748b"
        };

        const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: colors.text, 
                boxWidth: 12, 
                usePointStyle: true,
                font: { size: 11, family: "'Inter', sans-serif" }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              padding: 10,
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#fff',
              bodyColor: colors.text,
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: colors.text, font: { size: 10 } },
              title: {
                display: true,
                text: 'Simulation Year',
                color: colors.text,
                font: { size: 12, weight: '500' }
              }
            },
            y: {
              grid: { color: colors.grid },
              ticks: { color: colors.text, font: { size: 10 } },
              title: {
                display: true,
                text: 'Value',
                color: colors.text,
                font: { size: 12, weight: '500' }
              }
            }
          }
        };

        // 3. Chart Implementations
        
        // Chart 1: Existing Forest Carbon Reduction
        const ctx1 = document.getElementById('existingForestRateChart')?.getContext('2d');
        if (ctx1 && chartData.existing_forest_sequestration) {
            console.log("Found Chart 1 context and data");
            window.dashboardCharts.existingRate = new Chart(ctx1, {
              type: 'line',
              data: {
                labels: chartData.existing_forest_sequestration.years,
                datasets: [{
                  label: 'Carbon Reduction (MtCO‚ÇÇe/yr)',
                  data: chartData.existing_forest_sequestration.total_sequestration_mt,
                  borderColor: colors.forest,
                  backgroundColor: colors.forestLight,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0
                }]
              },
              options: {
                ...commonOptions,
                scales: {
                  ...commonOptions.scales,
                  y: {
                    ...commonOptions.scales.y,
                    title: { ...commonOptions.scales.y.title, text: 'Carbon Reduction (MtCO‚ÇÇe/yr)' }
                  }
                }
              }
            });
        }

        // Chart 2: Gross Emissions
        const ctx2 = document.getElementById('grossEmissionsChart')?.getContext('2d');
        if (ctx2 && chartData.gross_emissions) {
            console.log("Found Chart 2 context and data");
            window.dashboardCharts.grossEmissions = new Chart(ctx2, {
              type: 'bar',
              data: {
                labels: chartData.gross_emissions.years,
                datasets: [
                  {
                    type: 'bar',
                    label: 'Historical/Peak Data Points',
                    data: chartData.gross_emissions.sparse_data_points,
                    backgroundColor: colors.emissions,
                    borderRadius: 4,
                    maxBarThickness: 40
                  },
                  {
                    type: 'line',
                    label: 'Interpolated Pathway',
                    data: chartData.gross_emissions.interpolated_emissions,
                    borderColor: colors.text,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                  },
                  {
                    type: 'line',
                    label: 'Policy Sequestration Target',
                    data: chartData.gross_emissions.policy_target_line,
                    borderColor: colors.target,
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0
                  }
                ]
              },
              options: {
                ...commonOptions,
                scales: {
                  ...commonOptions.scales,
                  y: {
                    ...commonOptions.scales.y,
                    title: { ...commonOptions.scales.y.title, text: 'Gross Emissions (MtCO‚ÇÇe/yr)' }
                  }
                }
              }
            });
        }

        // Chart 3: Carbon Balance
        const ctx3 = document.getElementById('balanceChart')?.getContext('2d');
        if (ctx3 && chartData.carbon_balance) {
            console.log("Found Chart 3 context and data");
            window.dashboardCharts.balance = new Chart(ctx3, {
              type: 'line',
              data: {
                labels: chartData.carbon_balance.years,
                datasets: [
                  {
                    label: 'Gross Emissions',
                    data: chartData.carbon_balance.gross_emissions,
                    borderColor: colors.emissions,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                  },
                  {
                    label: 'Existing Sequestration (Sink)',
                    data: chartData.carbon_balance.existing_forest_sequestration,
                    borderColor: colors.forest,
                    backgroundColor: colors.forestLight,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                  },
                  {
                    label: 'Net Balance',
                    data: chartData.carbon_balance.net_balance,
                    borderColor: colors.balance,
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                  }
                ]
              },
              options: {
                ...commonOptions,
                scales: {
                  ...commonOptions.scales,
                  y: {
                    ...commonOptions.scales.y,
                    title: { ...commonOptions.scales.y.title, text: 'Cumulative Carbon Flux (MtCO‚ÇÇe)' },
                    grid: {
                      ...commonOptions.scales.y.grid,
                      color: (context) => context.tick?.value === 0 ? 'rgba(255, 255, 255, 0.4)' : colors.grid
                    }
                  }
                }
              }
            });
        }

        // Chart 4a: Annual New Planting
        const ctx4a = document.getElementById('annualPlantingChart')?.getContext('2d');
        if (ctx4a && chartData.new_planting) {
            console.log("Found Chart 4a context and data");
            window.dashboardCharts.annualPlanting = new Chart(ctx4a, {
              type: 'bar',
              data: {
                labels: chartData.new_planting.years,
                datasets: [{
                  label: 'New Planting Area (ha/year)',
                  data: chartData.new_planting.annual_planting_area,
                  backgroundColor: colors.coastal,
                  borderRadius: 4
                }]
              },
              options: {
                ...commonOptions,
                scales: {
                  ...commonOptions.scales,
                  y: {
                    ...commonOptions.scales.y,
                    title: { ...commonOptions.scales.y.title, text: 'Annual Planting Area (ha/yr)' }
                  }
                }
              }
            });
        }

        // Chart 4b: Cumulative Planted Area
        const ctx4b = document.getElementById('cumulativeAreaChart')?.getContext('2d');
        if (ctx4b && chartData.new_planting) {
            console.log("Found Chart 4b context and data");
            window.dashboardCharts.cumulativeArea = new Chart(ctx4b, {
              type: 'line',
              data: {
                labels: chartData.new_planting.years,
                datasets: [{
                  label: 'Cumulative Planted Area (ha)',
                  data: chartData.new_planting.cumulative_planted_area,
                  borderColor: colors.coastal,
                  backgroundColor: colors.coastalLight,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 2
                }]
              },
              options: {
                ...commonOptions,
                scales: {
                  ...commonOptions.scales,
                  y: {
                    ...commonOptions.scales.y,
                    title: { ...commonOptions.scales.y.title, text: 'Total Planted Area (ha)' }
                  },
                  x: {
                    ...commonOptions.scales.x,
                    grid: {
                      ...commonOptions.scales.x.grid,
                      display: true,
                      color: (context) => {
                        const year = parseInt(context.tick?.label);
                        return year === 2050 ? 'rgba(239, 68, 68, 0.5)' : colors.grid;
                      }
                    }
                  }
                }
              }
            });
        }

        // Figure 6: National Net Carbon Balance
        const ctx6 = document.getElementById('netZeroBalanceChart')?.getContext('2d');
        if (ctx6 && chartData.net_zero_balance) {
            window.dashboardCharts.netZeroBalance = new Chart(ctx6, {
              type: 'line',
              data: {
                labels: chartData.net_zero_balance.years,
                datasets: [
                  {
                    label: 'Gross Emissions',
                    data: chartData.net_zero_balance.gross_emissions,
                    borderColor: colors.emissions,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                  },
                  {
                    label: 'Existing Sequestration (Sink)',
                    data: chartData.net_zero_balance.existing_forest_sequestration,
                    borderColor: colors.forest,
                    backgroundColor: colors.forestLight,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                  },
                  {
                    label: 'New Planting Sequestration (Sink)',
                    data: chartData.net_zero_balance.new_planting_sequestration,
                    borderColor: colors.coastal,
                    backgroundColor: colors.coastalLight,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                  },
                  {
                    label: 'Net Balance',
                    data: chartData.net_zero_balance.net_balance,
                    borderColor: colors.balance,
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                  }
                ]
              },
              options: {
                ...commonOptions,
                scales: {
                  ...commonOptions.scales,
                  y: {
                    ...commonOptions.scales.y,
                    title: { ...commonOptions.scales.y.title, text: 'Cumulative Carbon Flux (MtCO‚ÇÇe)' },
                    grid: {
                      ...commonOptions.scales.y.grid,
                      color: (context) => context.tick?.value === 0 ? 'rgba(255, 255, 255, 0.4)' : colors.grid
                    }
                  }
                }
              }
            });
        }

        // 4. Form Interactions
        document.getElementById('resetBtn')?.addEventListener('click', () => {
          const form = document.getElementById('calculatorForm');
          if (dashboardDefaults) {
              Object.keys(dashboardDefaults).forEach(key => {
                const input = form.elements[key];
                if (input) {
                  if (input.type === 'checkbox') input.checked = dashboardDefaults[key];
                  else input.value = dashboardDefaults[key];
                  input.dispatchEvent(new Event('input', { bubbles: true }));
                }
              });
              form.submit();
          }
        });

        // Range value labels update
        document.querySelectorAll('input[type="range"]').forEach(range => {
          range.addEventListener('input', (e) => {
            const valueSpan = document.getElementById(e.target.id + 'Value') || 
                              (e.target.id === 'new_planting_forest_percent' ? document.getElementById('forestPercentValue') : null);
            if (valueSpan) {
              if (e.target.id === 'new_planting_forest_percent') {
                const val = parseInt(e.target.value);
                valueSpan.textContent = `${val}% / ${100 - val}%`;
              }
            }
          });
        });
      });
    </script>
  </body>
</html>
